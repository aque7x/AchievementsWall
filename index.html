<script>
const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbyE-pSmDgZslXgciZpcw-A_b6eTVCrWB0jKHRBgG0GibAFuWs2vvMlC5sr80Ehyi23E/exec';
let currentUser = null;
let boardData = [];
const colors = ['peach', 'mint', 'lavender', 'pink', 'sky'];
let saveTimer;

// عند تحميل الصفحة، اطلب بيانات الإنجازات
document.addEventListener('DOMContentLoaded', () => {
    const script = document.createElement('script');
    script.src = `${GOOGLE_SHEET_URL}?callback=loadDataFromSheet`;
    document.body.appendChild(script);
});

function loadDataFromSheet(result) {
    if (result.result !== 'success') {
        document.getElementById('loading').innerHTML = `<span>خطأ بتحميل البيانات: ${result.message}</span>`;
        return;
    }
    boardData = result.data.filter(item => item.id && item.id !== '').map(item => ({
        id: parseInt(item.id, 10),
        name: item.name || `مستخدم ${item.id}`,
        achievement: item.achievement || ''
    }));
    document.getElementById('loading').style.display = 'none';
    document.getElementById('loginScreen').style.display = 'flex';
}

function login(event) {
    event.preventDefault();
    const username = document.getElementById('username').value.toLowerCase();
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('errorMessage');
    const loginBtn = event.target.querySelector('button');
    
    // تعطيل الزر وإظهار رسالة انتظار
    loginBtn.disabled = true;
    loginBtn.textContent = 'جاري التحقق...';
    errorDiv.style.display = 'none';
    
    // إنشاء اسم دالة callback فريد
    const callbackName = 'loginCallback' + Date.now();

    // تعريف دالة الـ callback على المستوى العام
    window[callbackName] = (response) => {
        // تفعيل الزر مرة أخرى
        loginBtn.disabled = false;
        loginBtn.textContent = 'تسجيل الدخول';
        
        if (response.result === 'success') {
            currentUser = response.user;
            loginScreen.style.display = 'none';
            mainApp.style.display = 'block';
            document.getElementById('userInfo').textContent = `مرحباً، ${currentUser.displayName}`;
            renderBoard();
        } else {
            errorDiv.textContent = response.message || 'خطأ غير معروف';
            errorDiv.style.display = 'block';
        }

        // تنظيف: إزالة السكريبت ودالة الـ callback
        document.head.removeChild(script);
        delete window[callbackName];
    };

    // إرسال طلب JSONP إلى الواجهة الخلفية
    const script = document.createElement('script');
    script.src = `${GOOGLE_SHEET_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
    script.onerror = () => {
        // في حالة فشل الاتصال بالشبكة
        loginBtn.disabled = false;
        loginBtn.textContent = 'تسجيل الدخول';
        errorDiv.textContent = 'فشل الاتصال بالخادم. الرجاء التحقق من اتصالك بالإنترنت.';
        errorDiv.style.display = 'block';
        delete window[callbackName];
    };
    document.head.appendChild(script);
}

function logout() {
    currentUser = null;
    mainApp.style.display = 'none';
    loginScreen.style.display = 'flex';
    document.getElementById('username').value = '';
    document.getElementById('password').value = '';
    document.getElementById('errorMessage').style.display = 'none';
}

function renderBoard() {
    const grid = document.getElementById('achievementGrid');
    grid.innerHTML = '';
    boardData.forEach(cardData => {
        const card = document.createElement('div');
        card.className = 'sticky-note';
        
        const isAdmin = currentUser.type === 'admin';
        // الآن نتحقق من اسم العرض (displayName) بدلاً من الاسم القديم
        const isOwner = currentUser.type === 'student' && currentUser.displayName === cardData.name;
        const canEdit = isAdmin || isOwner;
        const colorClass = colors[cardData.id % colors.length];
        const firstLetter = cardData.name ? cardData.name.charAt(0) : '?';

        card.innerHTML = `
            <div class="name-label">${cardData.name}</div>
            <div class="profile-circle ${colorClass}"><span>${firstLetter}</span></div>
            <div class="writing-area">
              <textarea class="achievement-text" placeholder="اكتب إنجازاتك هنا..." ${!canEdit ? 'disabled' : ''}>${cardData.achievement}</textarea>
              ${canEdit ? '<div class="save-status"></div>' : ''}
            </div>
        `;

        if (canEdit) {
            const textarea = card.querySelector('.achievement-text');
            const saveStatus = card.querySelector('.save-status');

            textarea.addEventListener('input', () => {
                saveStatus.textContent = '...';
                saveStatus.style.color = '#636e72';
                clearTimeout(saveTimer);
                saveTimer = setTimeout(() => {
                    saveStatus.textContent = "⏳ جاري الحفظ...";
                    saveAchievementToSheet(cardData.id, textarea.value)
                        .then(() => {
                            saveStatus.textContent = "✅ تم الحفظ";
                            saveStatus.style.color = '#00b894';
                            const localCard = boardData.find(item => item.id === cardData.id);
                            if (localCard) localCard.achievement = textarea.value;
                        })
                        .catch(error => {
                            console.error('خطأ في الحفظ:', error);
                            saveStatus.textContent = "❌ خطأ في الحفظ";
                            saveStatus.style.color = '#ff7675';
                        });
                }, 1500);
            });
        }
        grid.appendChild(card);
    });
}

function saveAchievementToSheet(id, achievementText) {
    return new Promise((resolve, reject) => {
        const callbackName = 'saveCallback' + Date.now() + Math.random().toString().substr(2);
        window[callbackName] = (result) => {
            delete window[callbackName];
            if (document.head.contains(script)) document.head.removeChild(script);
            if (result.result === 'success') resolve(true);
            else reject(new Error(result.message || 'Unknown error'));
        };
        const script = document.createElement('script');
        // البيانات الآن تُرسل ككائن JSON داخل الباراميتر 'data'
        const data = { action: 'update', id: id, field: 'achievement', value: achievementText };
        script.src = `${GOOGLE_SHEET_URL}?callback=${callbackName}&data=${encodeURIComponent(JSON.stringify(data))}`;
        script.onerror = () => {
            delete window[callbackName];
            reject(new Error('فشل في الاتصال بالخادم'));
        };
        document.head.appendChild(script);
    });
}

function toggleAboutModal(show) {
    const modal = document.getElementById('aboutModal');
    modal.style.display = show ? 'flex' : 'none';
}
</script>
