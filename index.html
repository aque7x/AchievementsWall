<!-- ... نفس رأس الصفحة وCSS ... -->

<div id="mainApp" class="main-app">
  <div class="container">
    <div class="header">
      <div class="user-info">
        <button class="logout-btn" onclick="logout()">تسجيل خروج</button>
        <span id="userInfo"></span>
      </div>
      <h1 class="main-title">حائط الإنجازات</h1>
      <p class="subtitle">شنو حققت هذا الأسبوع؟</p>
      <button class="add-btn" onclick="addNewCard()">➕ إضافة بطاقة جديدة</button>
    </div>
    <div class="grid" id="achievementGrid"></div>
  </div>
</div>

<script>
// رابط Google Apps Script
const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbyE-pSmDgZslXgciZpcw-A_b6eTVCrWB0jKHRBgG0GibAFuWs2vvMlC5sr80Ehyi23E/exec';
let currentUser=null;
let boardData=[];
const users={ admin:{ password:'admin123', type:'admin', displayName:'المدير' } };
const colors=['peach','mint','lavender','pink','sky'];

function loadDataFromSheet(result){
    if(result.result!=='success'){
        document.getElementById('loading').innerHTML=`<span>خطأ بتحميل البيانات: ${result.message}</span>`;
        return;
    }
    
    boardData = result.data
        .filter(item => item.id && item.id !== '')
        .map(item=>({ 
            id: parseInt(item.id, 10), 
            name: item.name || `مستخدم ${item.id}`, 
            achievement: item.achievement || '' 
        }));
    
    populateUsersFromBoardData();
    document.getElementById('loading').style.display='none';
    document.getElementById('loginScreen').style.display='flex';
}

function populateUsersFromBoardData(){
    boardData.forEach((card,index)=>{
        let displayName = card.name && card.name.trim() !== '' ? card.name : `user_${card.id || index+1}`;
        let username = displayName.replace(/\s+/g,'').toLowerCase();
        if(!users[username]){
            users[username] = { password:'123', type:'student', displayName: displayName };
        }
    });
}

function login(event){
    event.preventDefault();
    const username=document.getElementById('username').value.toLowerCase();
    const password=document.getElementById('password').value;
    const user=users[username];
    if(user && user.password===password){
        currentUser={...user, username};
        loginScreen.style.display='none';
        mainApp.style.display='block';
        document.getElementById('userInfo').textContent=`مرحباً، ${currentUser.displayName}`;
        renderBoard();
    } else {
        const errorDiv=document.getElementById('errorMessage');
        errorDiv.textContent='اسم المستخدم أو كلمة المرور غير صحيحة';
        errorDiv.style.display='block';
    }
}

function logout(){
    currentUser=null;
    mainApp.style.display='none';
    loginScreen.style.display='flex';
    document.getElementById('username').value='';
    document.getElementById('password').value='';
}

function renderBoard(){
    const grid=document.getElementById('achievementGrid');
    grid.innerHTML='';
    boardData.forEach(cardData=>{
        const card=document.createElement('div');
        card.className='sticky-note';
        const isAdmin=currentUser.type==='admin';
        const isOwner=currentUser.type==='student' && currentUser.displayName===cardData.name;
        const canEdit=isAdmin||isOwner;
        const colorClass=colors[cardData.id%colors.length];
        const firstLetter=cardData.name?cardData.name.charAt(0):'?';

        card.innerHTML=`
            <div class="name-label">${cardData.name}</div>
            <div class="profile-circle ${colorClass}"><span>${firstLetter}</span></div>
            <div class="save-indicator" id="saveIndicator_${cardData.id}"></div>
            <div class="writing-area">
              <textarea class="achievement-text" placeholder="اكتب إنجازاتك هنا..." ${!canEdit?'disabled':''}>${cardData.achievement}</textarea>
            </div>
        `;

        if(canEdit){
            const textarea=card.querySelector('.achievement-text');
            const saveIndicator=card.querySelector('.save-indicator');
            let originalAchievement=textarea.value;
            let saveTimeout;

            function autoSave() {
                if (textarea.value !== originalAchievement) {
                    showSaveIndicator(saveIndicator, 'saving', 'جاري الحفظ...');
                    
                    saveToSheet(cardData.id, textarea.value)
                        .then(() => {
                            originalAchievement = textarea.value;
                            showSaveIndicator(saveIndicator, 'success', 'تم الحفظ');
                        })
                        .catch(error => {
                            console.error('خطأ في الحفظ:', error);
                            showSaveIndicator(saveIndicator, 'error', 'خطأ في الحفظ');
                        });
                }
            }

            function showSaveIndicator(indicator, type, text) {
                indicator.textContent = text;
                indicator.className = `save-indicator show ${type}`;
                if (type === 'success') setTimeout(()=>indicator.className='save-indicator',2000);
                if (type === 'error') setTimeout(()=>indicator.className='save-indicator',3000);
            }

            textarea.addEventListener('input', () => {
                clearTimeout(saveTimeout);
                saveTimeout = setTimeout(autoSave, 2000);
            });

            textarea.addEventListener('blur', () => {
                clearTimeout(saveTimeout);
                autoSave();
            });

            textarea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    textarea.blur();
                }
            });
        }

        grid.appendChild(card);
    });
}

function saveToSheet(id, achievement){
    return new Promise((resolve, reject)=>{
        const callback='saveCallback'+Date.now()+Math.random();
        window[callback]=(result)=>{
            delete window[callback];
            if(result.result==='success') resolve(true);
            else reject(new Error(result.message));
        };
        const script=document.createElement('script');
        const data={ action:'update', id:id, field:'achievement', value:achievement };
        script.src=`${GOOGLE_SHEET_URL}?callback=${callback}&data=${encodeURIComponent(JSON.stringify(data))}`;
        script.onerror=()=>reject(new Error('Failed to save'));
        document.head.appendChild(script);
        setTimeout(()=>{if(document.head.contains(script)) document.head.removeChild(script)},15000);
    });
}

function addNewCard(){
    const existingCard = boardData.find(c => c.name === currentUser.displayName && c.achievement === '');
    if (existingCard) { alert('لديك بطاقة فارغة بالفعل، الرجاء ملؤها أولاً.'); return; }

    const newId=Date.now(); 
    const newRow={ id:newId, name:currentUser.displayName, achievement:"" };

    const callback = 'addCallback' + Date.now() + Math.random();
    window[callback] = (result) => {
        if (document.head.contains(script)) document.head.removeChild(script);
        delete window[callback];
        if (result.result === 'success') {
            boardData.push(newRow);
            renderBoard();
        } else {
            alert("خطأ في إضافة البطاقة: " + result.message);
        }
    };
    const script=document.createElement('script');
    const data={ action:'add', row:newRow };
    script.src=`${GOOGLE_SHEET_URL}?callback=${callback}&data=${encodeURIComponent(JSON.stringify(data))}`;
    script.onerror=()=>alert("مشكلة في الشبكة أو الخادم");
    document.head.appendChild(script);
}

document.addEventListener('DOMContentLoaded',()=>{
    const script=document.createElement('script');
    script.src=`${GOOGLE_SHEET_URL}?callback=loadDataFromSheet`;
    document.body.appendChild(script);
});
</script>
