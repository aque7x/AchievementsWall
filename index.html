<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø­Ø§Ø¦Ø· Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Amiri', serif; background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); min-height:100vh; padding:40px 20px; direction:rtl; }
.loading-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:2000; display:flex; align-items:center; justify-content:center; font-size:24px; color:#2d3436; }
.login-container { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
.login-box { background:white; padding:50px; border-radius:20px; box-shadow:0 15px 35px rgba(0,0,0,0.1); text-align:center; max-width:450px; width:100%; position:relative; }
.login-title { font-size:36px; color:#2d3436; margin-bottom:15px; }
.login-subtitle { font-size:18px; color:#636e72; margin-bottom:40px; }
.form-group { margin-bottom:25px; text-align:right; }
.form-group label { display:block; margin-bottom:8px; font-weight:600; }
.form-input { width:100%; padding:15px; border:2px solid #ddd; border-radius:10px; font-size:16px; text-align:right; }
.login-btn, .action-btn { width:100%; padding:15px; background:linear-gradient(135deg,#00b894,#00a085); color:white; border:none; border-radius:10px; font-size:18px; cursor:pointer; transition: background-color 0.3s ease; }
.login-btn:disabled, .action-btn:disabled { background: #b2bec3; cursor: not-allowed; }
.error-message, .success-message { padding:10px; border-radius:8px; margin-bottom:20px; display:none; }
.error-message { background:#ff7675; color:white; }
.success-message { background:#55efc4; color:#2d3436; }
.main-app { display:none; }
.container { max-width:1400px; margin:0 auto; }
.header { text-align:center; margin-bottom:30px; position:relative; }
.user-info { position:absolute; top:0; left:20px; background:white; padding:10px 20px; border-radius:20px; box-shadow:0 3px 10px rgba(0,0,0,0.1); font-size:14px; display:flex; align-items:center; gap: 10px; }
.logout-btn, .change-pass-btn { color:white; border:none; padding:8px 15px; border-radius:15px; cursor:pointer; font-size:12px; }
.logout-btn { background:#ff7675; }
.change-pass-btn { background:#74b9ff; }
.main-title { font-size:56px; color:#2d3436; margin-bottom:15px; }
.subtitle { font-size:24px; color:#636e72; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:25px; max-width:1400px; margin:30px auto; }
.sticky-note { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); width:220px; height:300px; position:relative; transition:all 0.3s ease; margin:0 auto; padding-bottom:40px; }
.sticky-note:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(0,0,0,0.12); }
.name-label { background:linear-gradient(135deg,#fab1a0 0%,#e17055 100%); color:#2d3436; padding:8px 16px; border-radius:20px; font-size:16px; position:absolute; top:-12px; right:20px; box-shadow:0 3px 8px rgba(0,0,0,0.15); }
.profile-circle { width:50px; height:50px; border-radius:50%; position:absolute; top:20px; left:-10px; box-shadow:0 4px 12px rgba(0,0,0,0.15); border:3px solid #fff; display:flex; align-items:center; justify-content:center; font-size:18px; color:#fff; overflow:hidden; background:#636e72; }
.writing-area { padding:45px 20px 20px 60px; height:calc(100% - 20px); display:flex; flex-direction:column; }
.achievement-text { flex:1; width:100%; border:none; background:transparent; font-family:'Amiri', serif; font-size:14px; line-height:26px; resize:none; outline:none; text-align:right; }
.achievement-text:disabled { cursor:not-allowed; opacity:0.7; }
.save-status { margin-top:10px; font-size:13px; color:#636e72; height:15px; text-align:left; transition: color 0.3s ease; }
.about-link { font-size: 14px; color: #636e72; margin-top: 20px; cursor: pointer; text-decoration: underline; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; }
.modal-content { background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; text-align: center; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-content h2 { font-size: 32px; margin-bottom: 20px; color: #2d3436; }
.modal-content p { font-size: 18px; line-height: 1.8; color: #636e72; margin-bottom: 15px; }
.modal-content h3 { font-size: 22px; margin-top: 30px; margin-bottom: 15px; color: #00b894; }
.close-btn { position: absolute; top: 15px; left: 20px; background: none; border: none; font-size: 30px; cursor: pointer; color: #636e72; }
.social-links a { display: inline-block; text-decoration: none; background: #00b894; color: white; padding: 10px 20px; border-radius: 25px; margin: 5px; font-size: 16px; transition: background 0.3s ease; }
.social-links a:hover { background: #00a085; }
.tasks-container { background: white; max-width: 800px; margin: 40px auto; padding: 30px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
.tasks-container h2 { text-align: center; font-size: 28px; color: #2d3436; margin-bottom: 25px; }
.tasks-list { list-style: none; padding: 0; }
.task-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid #dfe6e9; font-size: 18px; }
.task-item:last-child { border-bottom: none; }
.task-content { flex-grow: 1; }
.task-actions button { background: none; border: none; cursor: pointer; font-size: 16px; margin-right: 10px; }
.task-actions .delete-btn { color: #ff7675; }
.add-task-form { display: flex; gap: 10px; margin-top: 20px; }
.add-task-form input { flex-grow: 1; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
.add-task-form button { padding: 12px 20px; background: #00b894; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }

@media (max-width: 768px) {
    body { padding: 20px 10px; }
    .header { position: static; display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px; }
    .user-info { position: static; }
    .main-title { font-size: 40px; }
    .subtitle { font-size: 18px; }
    .login-box, .modal-content { padding: 30px 25px; width: 95%; }
    .login-title { font-size: 28px; }
    .tasks-container { padding: 20px 15px; }
    .task-item { font-size: 16px; padding: 12px; flex-direction: column; align-items: flex-start; gap: 10px; }
    .add-task-form { flex-direction: column; }
    .grid { gap: 15px; }
    .sticky-note { width: 100%; }
}
</style>
</head>
<body>
<div id="loading" class="loading-overlay"><span>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</span></div>

<div id="loginScreen" class="login-container">
  <div class="login-box">
    <h2 class="login-title">Ø­Ø§Ø¦Ø· Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</h2>
    <p class="login-subtitle">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ! Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©</p>
    <div id="errorMessage" class="error-message"></div>
    <form onsubmit="login(event)">
      <div class="form-group"><label for="username">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</label><input type="text" id="username" class="form-input" required></div>
      <div class="form-group"><label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label><input type="password" id="password" class="form-input" required></div>
      <button type="submit" class="login-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </form>
    <div class="about-link" onclick="toggleAboutModal(true)">Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆØ±</div>
  </div>
</div>

<div id="mainApp" class="main-app">
  <div class="container">
    <div class="header">
      <div class="user-info">
        <button class="change-pass-btn" onclick="togglePasswordModal(true)">ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±</button>
        <button class="logout-btn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
        <span id="userInfo"></span>
      </div>
      <h1 class="main-title">Ø­Ø§Ø¦Ø· Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</h1>
    </div>
    
    <div id="tasksSection" class="tasks-container">
      <h2>Ù…Ù‡Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h2>
      <ul id="tasksList" class="tasks-list"></ul>
      <div id="adminTaskControls" style="display: none;">
        <form onsubmit="handleAddTask(event)" class="add-task-form">
          <input type="text" id="newTaskContent" placeholder="Ø£Ø¶Ù Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©..." required>
          <button type="submit">Ø¥Ø¶Ø§ÙØ©</button>
        </form>
      </div>
    </div>

    <p class="subtitle" style="text-align: center; margin-top: 50px;">Ø´Ù†Ùˆ Ø­Ù‚Ù‚Øª Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŸ</p>
    <div class="grid" id="achievementGrid"></div>
  </div>
</div>

<div id="aboutModal" class="modal-overlay" onclick="toggleAboutModal(false)"><div class="modal-content" onclick="event.stopPropagation()"><button class="close-btn" onclick="toggleAboutModal(false)">&times;</button><h2>Ø¹Ù† Ø§Ù„Ù…Ø·ÙˆØ±</h2><p><strong>Ø¨Ù„Ø§Ù„ Ø²Ø§Ù…Ù„</strong><br>Ø·Ø§Ù„Ø¨ Ù…Ø±Ø­Ù„Ø© Ø«Ø§Ù†ÙŠØ©ØŒ Ø¹Ù„ÙˆÙ… Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ - Ø¬Ø§Ù…Ø¹Ø© Ø§Ù„Ø£Ù†Ø¨Ø§Ø±.</p><h3>Ø§Ù„Ù‡Ø¯Ù Ù…Ù† Ø§Ù„Ù…Ù†ØµØ©</h3><p>ØªÙ‡Ø¯Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†ØµØ© Ø¥Ù„Ù‰ ØªÙˆÙÙŠØ± Ù…Ø³Ø§Ø­Ø© ØªØ´Ø§Ø±ÙƒÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨ Ù„ØªÙˆØ«ÙŠÙ‚ ÙˆÙ…Ø´Ø§Ø±ÙƒØ© Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙ‡Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©.</p><h3>ØªÙˆØ§ØµÙ„ Ù…Ø¹ÙŠ</h3><div class="social-links"><a href="https://instagram.com/bilalcodes1" target="_blank">Ø§Ù†Ø³ØªØºØ±Ø§Ù…</a><a href="https://t.me/bilalcodes1" target="_blank">ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…</a></div></div></div>
<div id="passwordModal" class="modal-overlay" onclick="togglePasswordModal(false)"><div class="modal-content" onclick="event.stopPropagation()"><button class="close-btn" onclick="togglePasswordModal(false)">&times;</button><h2>ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2><div id="passwordChangeError" class="error-message"></div><div id="passwordChangeSuccess" class="success-message"></div><form id="passwordChangeForm" onsubmit="handleChangePassword(event)"><div class="form-group"><label for="oldPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label><input type="password" id="oldPassword" class="form-input" required></div><div class="form-group"><label for="newPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label><input type="password" id="newPassword" class="form-input" required></div><div class="form-group"><label for="confirmNewPassword">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</label><input type="password" id="confirmNewPassword" class="form-input" required></div><button type="submit" class="action-btn">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button></form></div></div>

<script>
// --- START: NEW AND REFACTORED CODE ---

const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbyE-pSmDgZslXgciZpcw-A_b6eTVCrWB0jKHRBgG0GibAFuWs2vvMlC5sr80Ehyi23E/exec';   
let currentUser = null;
let boardData = [];
let weeklyTasks = [];
let saveTimer;
let updateInterval; // To hold the setInterval ID

const colors = ['peach', 'mint', 'lavender', 'pink', 'sky'];

// 1. CHECK FOR SAVED SESSION ON PAGE LOAD
// This function runs first to see if the user is already logged in.
document.addEventListener('DOMContentLoaded', () => {
    const savedUser = localStorage.getItem('currentUser');
    if (savedUser) {
        currentUser = JSON.parse(savedUser);
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userInfo').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.displayName}`;
        
        // Load data for the first time and then start the auto-update
        initialLoad();
    } else {
        // If no saved user, just show the login screen
        document.getElementById('loading').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'flex';
    }
});

// This function is for the very first data load
function initialLoad() {
    document.getElementById('loading').style.display = 'flex';
    Promise.all([
        fetchData(GOOGLE_SHEET_URL),
        fetchData(`${GOOGLE_SHEET_URL}?action=getTasks`)
    ]).then(([achievementsResult, tasksResult]) => {
        if (achievementsResult.result === 'success') {
            boardData = achievementsResult.data.filter(item => item.id && item.id !== '').map(item => ({
                id: parseInt(item.id, 10),
                name: item.name || `Ù…Ø³ØªØ®Ø¯Ù… ${item.id}`,
                achievement: item.achievement || '',
                username: item.username || ''
            }));
            renderBoardFirstTime(); // Full render
        }
        if (tasksResult.result === 'success') {
            weeklyTasks = tasksResult.data;
            renderTasksFirstTime(); // Full render
        }
    }).catch(error => {
        console.error("Error during initial load:", error);
        document.getElementById('loading').innerHTML = `<span>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙˆÙ„ÙŠØ©.</span>`;
    }).finally(() => {
        document.getElementById('loading').style.display = 'none';
        // 2. SET UPDATE INTERVAL TO 10 SECONDS
        // Start the periodic update ONLY after the initial load is complete.
        if (updateInterval) clearInterval(updateInterval); // Clear any old interval
        updateInterval = setInterval(updateData, 10000); // 10000ms = 10 seconds
    });
}

// This function will be called every 10 seconds to get new data
function updateData() {
    console.log("Checking for updates...");
    Promise.all([
        fetchData(GOOGLE_SHEET_URL),
        fetchData(`${GOOGLE_SHEET_URL}?action=getTasks`)
    ]).then(([achievementsResult, tasksResult]) => {
        if (achievementsResult.result === 'success') {
            const newBoardData = achievementsResult.data.filter(item => item.id && item.id !== '').map(item => ({
                id: parseInt(item.id, 10),
                name: item.name || `Ù…Ø³ØªØ®Ø¯Ù… ${item.id}`,
                achievement: item.achievement || '',
                username: item.username || ''
            }));
            // 3. SMART UPDATE WITHOUT FLICKERING (Achievements)
            updateBoardUI(newBoardData);
        }
        if (tasksResult.result === 'success') {
             // 3. SMART UPDATE WITHOUT FLICKERING (Tasks)
            updateTasksUI(tasksResult.data);
        }
    }).catch(error => {
        console.error("Error during periodic update:", error);
    });
}


function login(event) {
    event.preventDefault();
    const username = document.getElementById('username').value.toLowerCase();
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('errorMessage');
    const loginBtn = event.target.querySelector('button');
    loginBtn.disabled = true; loginBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...'; errorDiv.style.display = 'none';

    fetchData(`${GOOGLE_SHEET_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`)
        .then(response => {
            if (response.result === 'success') {
                currentUser = response.user;
                // 4. SAVE USER TO LOCALSTORAGE ON LOGIN
                // This keeps the user logged in even after a page refresh.
                localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
                
                loginScreen.style.display = 'none'; 
                mainApp.style.display = 'block';
                document.getElementById('userInfo').textContent = `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ ${currentUser.displayName}`;
                initialLoad(); // Load data for the first time
            } else {
                errorDiv.textContent = response.message || 'Ø®Ø·Ø£ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'; 
                errorDiv.style.display = 'block';
            }
        })
        .catch(error => {
            errorDiv.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….'; 
            errorDiv.style.display = 'block';
        })
        .finally(() => {
            loginBtn.disabled = false; 
            loginBtn.textContent = 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        });
}

function logout() {
    // 5. REMOVE USER FROM LOCALSTORAGE ON LOGOUT
    localStorage.removeItem('currentUser');
    
    currentUser = null; 
    clearInterval(updateInterval); // Stop auto-updates
    mainApp.style.display = 'none'; 
    loginScreen.style.display = 'flex'; 
    document.getElementById('username').value = ''; 
    document.getElementById('password').value = ''; 
    document.getElementById('errorMessage').style.display = 'none'; 
}


// --- SMART UI UPDATE FUNCTIONS (TO PREVENT FLICKERING) ---

function updateBoardUI(newBoardData) {
    const grid = document.getElementById('achievementGrid');
    const newIds = new Set(newBoardData.map(d => d.id));
    
    // Update existing notes and add new ones
    newBoardData.forEach(cardData => {
        const existingCard = grid.querySelector(`.sticky-note[data-id='${cardData.id}']`);
        if (existingCard) {
            // Card exists, just update the text if it's different and not being edited
            const textarea = existingCard.querySelector('.achievement-text');
            if (textarea && textarea.value !== cardData.achievement && document.activeElement !== textarea) {
                textarea.value = cardData.achievement;
            }
        } else {
            // Card is new, create and append it
            const card = createStickyNoteElement(cardData);
            grid.appendChild(card);
        }
    });

    // Remove old notes that are no longer in the data
    const currentCards = grid.querySelectorAll('.sticky-note');
    currentCards.forEach(card => {
        const cardId = parseInt(card.dataset.id, 10);
        if (!newIds.has(cardId)) {
            card.remove();
        }
    });
    
    boardData = newBoardData; // Update the global data variable
}

function updateTasksUI(newTasks) {
    const tasksList = document.getElementById('tasksList');
    const newTaskIds = new Set(newTasks.map(t => t.taskId));
    
    // Update existing tasks and add new ones
    newTasks.forEach(task => {
        const existingTask = tasksList.querySelector(`li[data-task-id='${task.taskId}']`);
        if (existingTask) {
            // Task exists, update content if different
            const contentSpan = existingTask.querySelector('.task-content');
            if (contentSpan && contentSpan.textContent !== task.taskContent) {
                contentSpan.textContent = task.taskContent;
            }
        } else {
            // Task is new, create and append it
             const li = createTaskElement(task);
             tasksList.appendChild(li);
        }
    });

    // Remove old tasks
    const currentTasks = tasksList.querySelectorAll('li[data-task-id]');
    if (currentTasks.length === 0 && newTasks.length > 0) {
        tasksList.innerHTML = ''; // Clear "no tasks" message
        newTasks.forEach(task => tasksList.appendChild(createTaskElement(task)));
    } else {
        currentTasks.forEach(li => {
            if (!newTaskIds.has(li.dataset.taskId)) {
                li.remove();
            }
        });
    }

    if (tasksList.children.length === 0) {
        tasksList.innerHTML = '<li class="task-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</li>';
    } else if (tasksList.querySelector('.task-item').textContent === 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.' && newTasks.length > 0) {
        tasksList.innerHTML = '';
        newTasks.forEach(task => tasksList.appendChild(createTaskElement(task)));
    }
    
    weeklyTasks = newTasks; // Update global data
}


// --- ELEMENT CREATION AND INITIAL RENDER FUNCTIONS ---

// This function creates a single sticky note element. Used by both initial render and smart update.
function createStickyNoteElement(cardData) {
    const card = document.createElement('div');
    card.className = 'sticky-note';
    card.dataset.id = cardData.id; // Add data-id for easy selection
    
    const isAdmin = currentUser.type === 'admin';
    const isOwner = currentUser.type === 'student' && currentUser.username === cardData.username;
    const canEdit = isAdmin || isOwner;
    const colorClass = colors[cardData.id % colors.length];
    const firstLetter = cardData.name ? cardData.name.charAt(0) : '?';
    
    card.innerHTML = `<div class="name-label">${cardData.name}</div><div class="profile-circle ${colorClass}"><span>${firstLetter}</span></div><div class="writing-area"><textarea class="achievement-text" placeholder="Ø§ÙƒØªØ¨ Ø¥Ù†Ø¬Ø§Ø²Ø§ØªÙƒ Ù‡Ù†Ø§..." ${!canEdit ? 'disabled' : ''}>${cardData.achievement}</textarea>${canEdit ? '<div class="save-status"></div>' : ''}</div>`;
    
    if (canEdit) {
        const textarea = card.querySelector('.achievement-text');
        const saveStatus = card.querySelector('.save-status');
        textarea.addEventListener('input', () => {
            saveStatus.textContent = '...';
            saveStatus.style.color = '#636e72';
            clearTimeout(saveTimer);
            saveTimer = setTimeout(() => {
                saveStatus.textContent = "â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
                saveAchievementToSheet(cardData.id, textarea.value).then(() => {
                    saveStatus.textContent = "âœ… ØªÙ… Ø§Ù„Ø­ÙØ¸";
                    saveStatus.style.color = '#00b894';
                    const localCard = boardData.find(item => item.id === cardData.id);
                    if (localCard) localCard.achievement = textarea.value;
                }).catch(error => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸:', error);
                    saveStatus.textContent = "âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸";
                    saveStatus.style.color = '#ff7675';
                });
            }, 1500);
        });
    }
    return card;
}

function createTaskElement(task) {
    const li = document.createElement('li');
    li.className = 'task-item';
    li.dataset.taskId = task.taskId;

    let adminButtons = '';
    if (currentUser && currentUser.type === 'admin') {
        adminButtons = `<div class="task-actions"><button class="delete-btn" onclick="handleDeleteTask('${task.taskId}', this)">ğŸ—‘ï¸ Ø­Ø°Ù</button></div>`;
    }
    li.innerHTML = `<span class="task-content">${task.taskContent}</span>${adminButtons}`;
    return li;
}


// These functions run only ONCE for the initial page setup.
function renderBoardFirstTime() {
    const grid = document.getElementById('achievementGrid');
    grid.innerHTML = '';
    boardData.forEach(cardData => {
        const card = createStickyNoteElement(cardData);
        grid.appendChild(card);
    });
}

function renderTasksFirstTime() {
    const tasksList = document.getElementById('tasksList');
    const adminControls = document.getElementById('adminTaskControls');
    tasksList.innerHTML = '';

    if (weeklyTasks.length === 0) {
        tasksList.innerHTML = '<li class="task-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</li>';
    } else {
        weeklyTasks.forEach(task => {
            const li = createTaskElement(task);
            tasksList.appendChild(li);
        });
    }

    if (currentUser && currentUser.type === 'admin') {
        adminControls.style.display = 'block';
    } else {
        adminControls.style.display = 'none';
    }
}


// --- UTILITY AND HELPER FUNCTIONS (MOSTLY UNCHANGED) ---

// A new helper function to handle JSONP requests with Promises, making the code cleaner
function fetchData(url) {
    return new Promise((resolve, reject) => {
        const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());
        window[callbackName] = (data) => {
            delete window[callbackName];
            document.body.removeChild(script);
            resolve(data);
        };
        const script = document.createElement('script');
        script.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + callbackName;
        script.onerror = reject;
        document.body.appendChild(script);
    });
}

function handleAddTask(event) {
    event.preventDefault();
    const input = document.getElementById('newTaskContent');
    const taskContent = input.value.trim();
    if (!taskContent) return;
    
    fetchData(`${GOOGLE_SHEET_URL}?action=handleTask&taskAction=add&taskContent=${encodeURIComponent(taskContent)}`)
        .then(response => {
            if (response.result === 'success') {
                const newTask = { taskId: response.newTaskId, taskContent: taskContent };
                weeklyTasks.push(newTask);
                
                if (document.querySelector('#tasksList .task-item').textContent === 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.') {
                    document.getElementById('tasksList').innerHTML = '';
                }
                document.getElementById('tasksList').appendChild(createTaskElement(newTask));
                input.value = '';
            } else {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©: ' + response.message);
            }
        });
}

function handleDeleteTask(taskId, buttonElement) {
    if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù‡Ù…Ø©ØŸ')) return;
    buttonElement.textContent = '...';
    
    fetchData(`${GOOGLE_SHEET_URL}?action=handleTask&taskAction=delete&taskId=${taskId}`)
        .then(response => {
            if (response.result === 'success') {
                weeklyTasks = weeklyTasks.filter(t => t.taskId !== taskId);
                const taskElement = document.querySelector(`li[data-task-id='${taskId}']`);
                if(taskElement) taskElement.remove();
                if (document.getElementById('tasksList').children.length === 0) {
                    document.getElementById('tasksList').innerHTML = '<li class="task-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹.</li>';
                }
            } else {
                alert('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©: ' + response.message);
                buttonElement.textContent = 'ğŸ—‘ï¸ Ø­Ø°Ù';
            }
        });
}

function saveAchievementToSheet(id, achievementText) { return new Promise((resolve, reject) => { const callbackName = 'saveCallback' + Date.now() + Math.random().toString().substr(2); window[callbackName] = (result) => { delete window[callbackName]; if (document.head.contains(script)) document.head.removeChild(script); if (result.result === 'success') resolve(true); else reject(new Error(result.message || 'Unknown error')); }; const script = document.createElement('script'); const data = { action: 'update', id: id, field: 'achievement', value: achievementText }; script.src = `${GOOGLE_SHEET_URL}?callback=${callbackName}&data=${encodeURIComponent(JSON.stringify(data))}`; script.onerror = () => { delete window[callbackName]; reject(new Error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…')); }; document.head.appendChild(script); }); }
function handleChangePassword(event) { event.preventDefault(); if (!currentUser) return; const oldPassword = document.getElementById('oldPassword').value; const newPassword = document.getElementById('newPassword').value; const confirmNewPassword = document.getElementById('confirmNewPassword').value; const errorDiv = document.getElementById('passwordChangeError'); const successDiv = document.getElementById('passwordChangeSuccess'); const submitBtn = document.getElementById('passwordChangeForm').querySelector('button'); errorDiv.style.display = 'none'; successDiv.style.display = 'none'; if (newPassword !== confirmNewPassword) { errorDiv.textContent = 'ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ØªØ§Ù† ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†.'; errorDiv.style.display = 'block'; return; } if (newPassword.length < 4) { errorDiv.textContent = 'ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© 4 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.'; errorDiv.style.display = 'block'; return; } submitBtn.disabled = true; submitBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'; const callbackName = 'passwordChangeCallback' + Date.now(); window[callbackName] = (response) => { submitBtn.disabled = false; submitBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª'; if (response.result === 'success') { successDiv.textContent = response.message; successDiv.style.display = 'block'; document.getElementById('passwordChangeForm').reset(); setTimeout(() => togglePasswordModal(false), 2000); } else { errorDiv.textContent = response.message; errorDiv.style.display = 'block'; } document.head.removeChild(script); delete window[callbackName]; }; const script = document.createElement('script'); const params = `action=changePassword&username=${encodeURIComponent(currentUser.username)}&oldPassword=${encodeURIComponent(oldPassword)}&newPassword=${encodeURIComponent(newPassword)}&callback=${callbackName}`; script.src = `${GOOGLE_SHEET_URL}?${params}`; script.onerror = () => { submitBtn.disabled = false; submitBtn.textContent = 'Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª'; errorDiv.textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù….'; errorDiv.style.display = 'block'; delete window[callbackName]; }; document.head.appendChild(script); }
function toggleAboutModal(show) { const modal = document.getElementById('aboutModal'); modal.style.display = show ? 'flex' : 'none'; }
function togglePasswordModal(show) { const modal = document.getElementById('passwordModal'); if (show) { document.getElementById('passwordChangeForm').reset(); document.getElementById('passwordChangeError').style.display = 'none'; document.getElementById('passwordChangeSuccess').style.display = 'none'; } modal.style.display = show ? 'flex' : 'none'; }

</script>
</body>
</html>
