<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>حائط الإنجازات</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:'Amiri', serif; background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); min-height:100vh; padding:40px 20px; direction:rtl; }
.loading-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:2000; display:flex; align-items:center; justify-content:center; font-size:24px; color:#2d3436; }
.login-container { display:flex; align-items:center; justify-content:center; min-height:100vh; padding:20px; }
.login-box { background:white; padding:50px; border-radius:20px; box-shadow:0 15px 35px rgba(0,0,0,0.1); text-align:center; max-width:450px; width:100%; position:relative; }
.login-title { font-size:36px; color:#2d3436; margin-bottom:15px; }
.login-subtitle { font-size:18px; color:#636e72; margin-bottom:40px; }
.form-group { margin-bottom:25px; text-align:right; }
.form-group label { display:block; margin-bottom:8px; font-weight:600; }
.form-input { width:100%; padding:15px; border:2px solid #ddd; border-radius:10px; font-size:16px; text-align:right; }
.login-btn, .action-btn { width:100%; padding:15px; background:linear-gradient(135deg,#00b894,#00a085); color:white; border:none; border-radius:10px; font-size:18px; cursor:pointer; transition: background-color 0.3s ease; }
.login-btn:disabled, .action-btn:disabled { background: #b2bec3; cursor: not-allowed; }
.error-message, .success-message { padding:10px; border-radius:8px; margin-bottom:20px; display:none; }
.error-message { background:#ff7675; color:white; }
.success-message { background:#55efc4; color:#2d3436; }
.main-app { display:none; }
.container { max-width:1400px; margin:0 auto; }
.header { text-align:center; margin-bottom:30px; position:relative; }
.user-info { position:absolute; top:0; left:20px; background:white; padding:10px 20px; border-radius:20px; box-shadow:0 3px 10px rgba(0,0,0,0.1); font-size:14px; display:flex; align-items:center; gap: 10px; }
.logout-btn, .change-pass-btn { color:white; border:none; padding:8px 15px; border-radius:15px; cursor:pointer; font-size:12px; }
.logout-btn { background:#ff7675; }
.change-pass-btn { background:#74b9ff; }
.main-title { font-size:56px; color:#2d3436; margin-bottom:15px; }
.subtitle { font-size:24px; color:#636e72; }
.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:25px; max-width:1400px; margin:30px auto; }
.sticky-note { background:#fff; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.08); width:220px; height:300px; position:relative; transition:all 0.3s ease; margin:0 auto; padding-bottom:40px; }
.sticky-note:hover { transform:translateY(-3px); box-shadow:0 8px 25px rgba(0,0,0,0.12); }
.name-label { background:linear-gradient(135deg,#fab1a0 0%,#e17055 100%); color:#2d3436; padding:8px 16px; border-radius:20px; font-size:16px; position:absolute; top:-12px; right:20px; box-shadow:0 3px 8px rgba(0,0,0,0.15); }
.profile-circle { width:50px; height:50px; border-radius:50%; position:absolute; top:20px; left:-10px; box-shadow:0 4px 12px rgba(0,0,0,0.15); border:3px solid #fff; display:flex; align-items:center; justify-content:center; font-size:18px; color:#fff; overflow:hidden; background:#636e72; }
.writing-area { padding:45px 20px 20px 60px; height:calc(100% - 20px); display:flex; flex-direction:column; }
.achievement-text { flex:1; width:100%; border:none; background:transparent; font-family:'Amiri', serif; font-size:14px; line-height:26px; resize:none; outline:none; text-align:right; }
.achievement-text:disabled { cursor:not-allowed; opacity:0.7; }
.save-status { margin-top:10px; font-size:13px; color:#636e72; height:15px; text-align:left; transition: color 0.3s ease; }
.about-link { font-size: 14px; color: #636e72; margin-top: 20px; cursor: pointer; text-decoration: underline; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; display: none; align-items: center; justify-content: center; }
.modal-content { background: white; padding: 40px; border-radius: 20px; max-width: 500px; width: 90%; text-align: center; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
.modal-content h2 { font-size: 32px; margin-bottom: 20px; color: #2d3436; }
.modal-content p { font-size: 18px; line-height: 1.8; color: #636e72; margin-bottom: 15px; }
.modal-content h3 { font-size: 22px; margin-top: 30px; margin-bottom: 15px; color: #00b894; }
.close-btn { position: absolute; top: 15px; left: 20px; background: none; border: none; font-size: 30px; cursor: pointer; color: #636e72; }
.social-links a { display: inline-block; text-decoration: none; background: #00b894; color: white; padding: 10px 20px; border-radius: 25px; margin: 5px; font-size: 16px; transition: background 0.3s ease; }
.social-links a:hover { background: #00a085; }
.tasks-container { background: white; max-width: 800px; margin: 40px auto; padding: 30px; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
.tasks-container h2 { text-align: center; font-size: 28px; color: #2d3436; margin-bottom: 25px; }
.tasks-list { list-style: none; padding: 0; }
.task-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid #dfe6e9; font-size: 18px; gap: 15px; }
.task-item:last-child { border-bottom: none; }
.task-content { flex-grow: 1; }
.task-actions button { background: none; border: none; cursor: pointer; font-size: 16px; margin-right: 10px; }
.task-actions .delete-btn { color: #ff7675; }
.add-task-form { display: flex; gap: 10px; margin-top: 20px; }
.add-task-form input { flex-grow: 1; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; }
.add-task-form button { padding: 12px 20px; background: #00b894; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; }
.task-checkbox { width: 20px; height: 20px; cursor: pointer; }

/* --- جديد: ستايل شريط التقدم --- */
.progress-section { margin-bottom: 25px; }
.progress-label { display: block; text-align: center; margin-bottom: 10px; font-size: 18px; color: #636e72; }
.progress-bar-container { width: 100%; background-color: #e9ecef; border-radius: 25px; height: 25px; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
.progress-bar-fill { width: 0%; height: 100%; background: linear-gradient(135deg, #55efc4, #00b894); border-radius: 25px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }

@media (max-width: 768px) {
    body { padding: 20px 10px; }
    .header { position: static; display: flex; flex-direction: column; align-items: center; gap: 20px; margin-bottom: 20px; }
    .user-info { position: static; }
    .main-title { font-size: 40px; }
    .subtitle { font-size: 18px; }
    .login-box, .modal-content { padding: 30px 25px; width: 95%; }
    .login-title { font-size: 28px; }
    .tasks-container { padding: 20px 15px; }
    .task-item { font-size: 16px; padding: 12px; flex-direction: row; align-items: center; }
    .add-task-form { flex-direction: column; }
    .grid { gap: 15px; }
    .sticky-note { width: 100%; }
}
</style>
</head>
<body>
<div id="loading" class="loading-overlay"><span>جاري تحميل البيانات...</span></div>

<div id="loginScreen" class="login-container" style="display: none;">
  <div class="login-box">
    <h2 class="login-title">حائط الإنجازات</h2>
    <p class="login-subtitle">مرحباً بك! الرجاء تسجيل الدخول للمتابعة</p>
    <div id="errorMessage" class="error-message"></div>
    <form onsubmit="login(event)">
      <div class="form-group"><label for="username">اسم المستخدم:</label><input type="text" id="username" class="form-input" required></div>
      <div class="form-group"><label for="password">كلمة المرور:</label><input type="password" id="password" class="form-input" required></div>
      <button type="submit" class="login-btn">تسجيل الدخول</button>
    </form>
    <div class="about-link" onclick="toggleAboutModal(true)">عن المطور</div>
  </div>
</div>

<div id="mainApp" class="main-app">
  <div class="container">
    <div class="header">
      <div class="user-info">
        <button class="change-pass-btn" onclick="togglePasswordModal(true)">تغيير كلمة السر</button>
        <button class="logout-btn" onclick="logout()">تسجيل خروج</button>
        <span id="userInfo"></span>
      </div>
      <h1 class="main-title">حائط الإنجازات</h1>
    </div>
    
    <div id="tasksSection" class="tasks-container">
      <h2>مهام هذا الأسبوع</h2>
      
      <div class="progress-section">
        <span class="progress-label" id="progressLabel">التقدم الإجمالي لإنجاز المهام</span>
        <div class="progress-bar-container">
          <div class="progress-bar-fill" id="progressBar">0%</div>
        </div>
      </div>
      <ul id="tasksList" class="tasks-list"></ul>
      <div id="adminTaskControls" style="display: none;">
        <form onsubmit="handleAddTask(event)" class="add-task-form">
          <input type="text" id="newTaskContent" placeholder="أضف مهمة جديدة..." required>
          <button type="submit">إضافة</button>
        </form>
      </div>
    </div>

    <p class="subtitle" style="text-align: center; margin-top: 50px;">شنو حققت هذا الأسبوع؟</p>
    <div class="grid" id="achievementGrid"></div>
  </div>
</div>

<div id="aboutModal" class="modal-overlay" onclick="toggleAboutModal(false)"><div class="modal-content" onclick="event.stopPropagation()"><button class="close-btn" onclick="toggleAboutModal(false)">&times;</button><h2>عن المطور</h2><p><strong>بلال زامل</strong><br>طالب مرحلة ثانية، علوم الحاسوب - جامعة الأنبار.</p><h3>الهدف من المنصة</h3><p>تهدف هذه المنصة إلى توفير مساحة تشاركية للطلاب لتوثيق ومشاركة إنجازاتهم الأسبوعية.</p><h3>تواصل معي</h3><div class="social-links"><a href="https://instagram.com/bilalcodes1" target="_blank">انستغرام</a><a href="https://t.me/bilalcodes1" target="_blank">تيليجرام</a></div></div></div>
<div id="passwordModal" class="modal-overlay" onclick="togglePasswordModal(false)"><div class="modal-content" onclick="event.stopPropagation()"><button class="close-btn" onclick="togglePasswordModal(false)">&times;</button><h2>تغيير كلمة المرور</h2><div id="passwordChangeError" class="error-message"></div><div id="passwordChangeSuccess" class="success-message"></div><form id="passwordChangeForm" onsubmit="handleChangePassword(event)"><div class="form-group"><label for="oldPassword">كلمة المرور الحالية:</label><input type="password" id="oldPassword" class="form-input" required></div><div class="form-group"><label for="newPassword">كلمة المرور الجديدة:</label><input type="password" id="newPassword" class="form-input" required></div><div class="form-group"><label for="confirmNewPassword">تأكيد كلمة المرور الجديدة:</label><input type="password" id="confirmNewPassword" class="form-input" required></div><button type="submit" class="action-btn">حفظ التغييرات</button></form></div></div>


<script>
const GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbyE-pSmDgZslXgciZpcw-A_b6eTVCrWB0jKHRBgG0GibAFuWs2vvMlC5sr80Ehyi23E/exec';   
let currentUser = null;
let boardData = [];
let weeklyTasks = [];
const colors = ['peach', 'mint', 'lavender', 'pink', 'sky'];
let saveTimer;
let refreshInterval = null;

document.addEventListener('DOMContentLoaded', () => {
    checkSession();
    if (currentUser) {
        // إذا كان المستخدم مسجل، جلب كل البيانات
        fetchInitialData();
    } else {
        // إذا لم يكن مسجل، أظهر شاشة الدخول فقط
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('loading').style.display = 'none';
    }
});

function checkSession() {
    const storedUser = localStorage.getItem('currentUser');
    if (storedUser) {
        currentUser = JSON.parse(storedUser);
    }
}

/**
 * START: تعديل منطق جلب البيانات الأولي
 * الآن يتم جلب 3 أنواع من البيانات
 */
let loadedResources = 0;
function fetchInitialData() {
    loadedResources = 0; // إعادة تعيين العداد
    document.getElementById('loading').style.display = 'flex';
    
    // 1. جلب الإنجازات
    const scriptAchievements = document.createElement('script');
    scriptAchievements.src = `${GOOGLE_SHEET_URL}?callback=loadDataFromSheet`;
    document.body.appendChild(scriptAchievements);
    
    // 2. جلب المهام مع حالتها للمستخدم الحالي
    const scriptTasks = document.createElement('script');
    scriptTasks.src = `${GOOGLE_SHEET_URL}?action=getTasks&username=${currentUser.username}&callback=loadTasksFromSheet`;
    document.body.appendChild(scriptTasks);

    // 3. جلب نسبة التقدم الإجمالية
    const scriptProgress = document.createElement('script');
    scriptProgress.src = `${GOOGLE_SHEET_URL}?action=getOverallProgress&callback=loadProgress`;
    document.body.appendChild(scriptProgress);
}

function loadDataFromSheet(result) {
    if (result.result === 'success') {
        boardData = result.data.filter(item => item.id && item.id !== '').map(item => ({
            id: parseInt(item.id, 10), name: item.name || `مستخدم ${item.id}`, achievement: item.achievement || '', username: item.username || ''
        }));
    }
    checkLoadingComplete();
}

function loadTasksFromSheet(result) {
    if (result.result === 'success') {
        weeklyTasks = result.data;
    }
    checkLoadingComplete();
}

// دالة جديدة لاستقبال بيانات شريط التقدم
function loadProgress(result) {
    if (result.result === 'success') {
        updateProgressBar(result.progress);
    }
    checkLoadingComplete();
}

function checkLoadingComplete() {
    loadedResources++;
    if (loadedResources >= 3) { // الآن ننتظر 3 مصادر بيانات
        document.getElementById('loading').style.display = 'none';
        if (currentUser) {
            document.getElementById('userInfo').textContent = `مرحباً، ${currentUser.displayName}`;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            renderBoard();
            renderTasks();
            startAutoRefresh();
        } else {
            document.getElementById('loginScreen').style.display = 'flex';
        }
    }
}
// END: تعديل منطق جلب البيانات الأولي

function login(event) {
    event.preventDefault();
    const username = document.getElementById('username').value.toLowerCase();
    const password = document.getElementById('password').value;
    const errorDiv = document.getElementById('errorMessage');
    const loginBtn = event.target.querySelector('button');
    loginBtn.disabled = true; loginBtn.textContent = 'جاري التحقق...'; errorDiv.style.display = 'none';
    const callbackName = 'loginCallback' + Date.now();
    window[callbackName] = (response) => {
        loginBtn.disabled = false; loginBtn.textContent = 'تسجيل الدخول';
        if (response.result === 'success') {
            currentUser = response.user;
            localStorage.setItem('currentUser', JSON.stringify(currentUser)); 
            // بعد تسجيل الدخول، ابدأ بجلب كل البيانات
            fetchInitialData();
        } else {
            errorDiv.textContent = response.message || 'خطأ غير معروف'; errorDiv.style.display = 'block';
        }
        document.head.removeChild(script); delete window[callbackName];
    };
    const script = document.createElement('script');
    script.src = `${GOOGLE_SHEET_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&callback=${callbackName}`;
    document.head.appendChild(script);
}

function startAutoRefresh() {
    // ... no changes here
}
function stopAutoRefresh() {
    // ... no changes here
}
function refreshData() {
    // ... no changes here
}
function refreshBoardData(result) {
    // ... no changes here
}

function refreshTasksData(result) {
     if (result.result === 'success') {
        weeklyTasks = result.data;
        renderTasks(); // إعادة رسم قائمة المهام
    }
}

/**
 * START: تعديل جوهري على دالة عرض المهام
 */
function renderTasks() {
    const tasksList = document.getElementById('tasksList');
    const adminControls = document.getElementById('adminTaskControls');
    tasksList.innerHTML = '';

    if (weeklyTasks.length === 0) {
        tasksList.innerHTML = '<li class="task-item">لا توجد مهام حالياً.</li>';
    } else {
        weeklyTasks.forEach(task => {
            const li = document.createElement('li');
            li.className = 'task-item';
            li.dataset.taskId = task.taskId;
            
            // تحديد هل مربع الاختيار يجب أن يكون محدداً أم لا
            const isChecked = task.isCompleted ? 'checked' : '';
            const canCheck = currentUser.type === 'student';

            let adminButtons = '';
            if (currentUser && currentUser.type === 'admin') {
                adminButtons = `<div class="task-actions"><button class="delete-btn" onclick="handleDeleteTask('${task.taskId}', this)">🗑️ حذف</button></div>`;
            }

            // إضافة مربع الاختيار (checkbox)
            li.innerHTML = `
                <input type="checkbox" class="task-checkbox" ${isChecked} ${!canCheck ? 'disabled' : ''} onchange="handleTaskStatusChange(event, '${task.taskId}')">
                <span class="task-content">${task.taskContent}</span>
                ${adminButtons}
            `;
            tasksList.appendChild(li);
        });
    }

    adminControls.style.display = (currentUser && currentUser.type === 'admin') ? 'block' : 'none';
}
// END: تعديل جوهري على دالة عرض المهام

/**
 * START: دالة جديدة لمعالجة تغيير حالة المهمة
 */
function handleTaskStatusChange(event, taskId) {
    const isCompleted = event.target.checked;
    event.target.disabled = true; // تعطيل المربع مؤقتاً لمنع النقرات المتعددة

    const callbackName = 'updateStatusCallback' + Date.now();
    window[callbackName] = (response) => {
        if (response.result === 'success') {
            // تحديث شريط التقدم بالنسبة الجديدة القادمة من السيرفر
            updateProgressBar(response.newProgress);
        } else {
            alert('حدث خطأ في تحديث المهمة. الرجاء المحاولة مرة أخرى.');
            // في حالة الفشل، أرجع حالة المربع إلى ما كانت عليه
            event.target.checked = !isCompleted;
        }
        event.target.disabled = false; // إعادة تفعيل المربع
        document.head.removeChild(script);
        delete window[callbackName];
    };

    const script = document.createElement('script');
    script.src = `${GOOGLE_SHEET_URL}?action=updateTaskStatus&username=${currentUser.username}&taskId=${taskId}&isCompleted=${isCompleted}&callback=${callbackName}`;
    document.head.appendChild(script);
}
// END: دالة جديدة لمعالجة تغيير حالة المهمة

/**
 * START: دالة جديدة لتحديث واجهة شريط التقدم
 */
function updateProgressBar(progress) {
    const progressBar = document.getElementById('progressBar');
    const roundedProgress = Math.round(progress);
    progressBar.style.width = `${roundedProgress}%`;
    progressBar.textContent = `${roundedProgress}%`;
}
// END: دالة جديدة لتحديث واجهة شريط التقدم


function handleAddTask(event) {
    // ... no changes here
}
function handleDeleteTask(taskId, buttonElement) {
    // ... no changes here
}
function logout() { 
    // ... no changes here
}
function updateBoard(newData) {
    // ... no changes here
}
function renderBoard() {
    // ... no changes here
}
function saveAchievementToSheet(id, achievementText) { 
    // ... no changes here
}
function handleChangePassword(event) {
    // ... no changes here
}
function toggleAboutModal(show) {
    // ... no changes here
}
function togglePasswordModal(show) {
    // ... no changes here
}

// --- لصق الدوال التي لم تتغير هنا ---
// (الدوال المتبقية مثل saveAchievementToSheet, handleChangePassword, etc.)
// ... (the rest of the functions from the previous version go here)
// Make sure to copy them from the previous answer to have the full working code.

</script>
</body>
</html>
