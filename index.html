// --- المتغيرات العامة ---
const SHEETS = {
  USERS: "Users",
  ACHIEVEMENTS: "Achievements",
  TASKS: "WeeklyTasks"
};

// --- الدالة الرئيسية ---
function doGet(e) {
  try {
    const action = e.parameter.action;

    // توجيه الطلبات بناءً على الباراميتر 'action'
    switch (action) {
      case 'login':
        return handleLogin(e);
      case 'changePassword':
        return handleChangePassword(e);
      case 'getTasks':
        return getWeeklyTasks(e);
      case 'handleTask': // معالج واحد لكل عمليات المهام
        return handleTaskAction(e);
      default:
        if (e.parameter.data) {
          const data = JSON.parse(e.parameter.data);
          if (data.action === 'update') {
            return handleUpdateRequest(data, e.parameter.callback);
          }
        }
        return getAchievements(e);
    }
  } catch (error) {
    console.error('Error in doGet:', error);
    const response = { result: 'error', message: error.message };
    const callback = e.parameter.callback || 'callback';
    return ContentService.createTextOutput(`${callback}(${JSON.stringify(response)})`)
      .setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
}

// --- دوال المهام الأسبوعية (جديد) ---
function getWeeklyTasks(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.TASKS);
  if (!sheet) throw new Error(`Sheet '${SHEETS.TASKS}' not found.`);
  
  if (sheet.getLastRow() < 2) { // إذا كانت الشيت فارغة أو تحتوي على العناوين فقط
    const response = { result: 'success', data: [] };
    return ContentService.createTextOutput(`${e.parameter.callback}(${JSON.stringify(response)})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
  }

  const dataRange = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn());
  const values = dataRange.getValues();
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  
  const data = values.map(row => {
    let obj = {};
    headers.forEach((header, index) => { obj[header] = row[index] || ''; });
    return obj;
  });
  
  const response = { result: 'success', data: data };
  return ContentService.createTextOutput(`${e.parameter.callback}(${JSON.stringify(response)})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
}

function handleTaskAction(e) {
  const callback = e.parameter.callback;
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.TASKS);
    if (!sheet) throw new Error(`Sheet '${SHEETS.TASKS}' not found.`);

    const taskAction = e.parameter.taskAction; // add, update, delete
    
    switch(taskAction) {
      case 'add':
        const taskContent = e.parameter.taskContent;
        const newTaskId = "task_" + new Date().getTime(); // إنشاء ID فريد
        sheet.appendRow([newTaskId, taskContent, false]);
        return ContentService.createTextOutput(`${callback}(${JSON.stringify({ result: 'success', newTaskId: newTaskId })})`).setMimeType(ContentService.MimeType.JAVASCRIPT);

      case 'delete':
        const taskIdToDelete = e.parameter.taskId;
        const taskIds = sheet.getRange(2, 1, sheet.getLastRow() - 1, 1).getValues();
        for (let i = 0; i < taskIds.length; i++) {
          if (taskIds[i][0] == taskIdToDelete) {
            sheet.deleteRow(i + 2);
            return ContentService.createTextOutput(`${callback}(${JSON.stringify({ result: 'success' })})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
          }
        }
        throw new Error("Task ID not found for deletion.");

      default:
        throw new Error("Invalid task action.");
    }

  } catch (error) {
     console.error('Error in handleTaskAction:', error);
     const response = { result: 'error', message: error.message };
     return ContentService.createTextOutput(`${callback}(${JSON.stringify(response)})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
}

// --- دوال المستخدمين والإنجازات (بدون تغيير) ---

function handleChangePassword(e) {
  const callback = e.parameter.callback;
  try {
    const username = e.parameter.username;
    const oldPassword = e.parameter.oldPassword;
    const newPassword = e.parameter.newPassword;

    const userSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.USERS);
    if (!userSheet) throw new Error(`Sheet '${SHEETS.USERS}' not found.`);

    const data = userSheet.getDataRange().getValues();
    const headers = data.shift();
    
    const usernameIndex = headers.indexOf('username');
    const passwordIndex = headers.indexOf('password');

    let userRowIndex = -1, passwordCorrect = false;

    for (let i = 0; i < data.length; i++) {
      if (data[i][usernameIndex] === username) {
        userRowIndex = i + 2;
        if (data[i][passwordIndex] == oldPassword) passwordCorrect = true;
        break;
      }
    }

    if (userRowIndex === -1) throw new Error("User not found.");
    if (!passwordCorrect) throw new Error("كلمة المرور القديمة غير صحيحة.");

    userSheet.getRange(userRowIndex, passwordIndex + 1).setValue(newPassword);
    
    const response = { result: 'success', message: 'تم تغيير كلمة المرور بنجاح!' };
    return ContentService.createTextOutput(`${callback}(${JSON.stringify(response)})`).setMimeType(ContentService.MimeType.JAVASCRIPT);

  } catch (error) {
    console.error('Error in handleChangePassword:', error);
    const response = { result: 'error', message: error.message };
    return ContentService.createTextOutput(`${callback}(${JSON.stringify(response)})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
}

function handleLogin(e) {
  const callback = e.parameter.callback;
  try {
    const username = e.parameter.username;
    const password = e.parameter.password;
    
    const userSheet = SpreadsheetApp.getActiveSpreadreedsheet().getSheetByName(SHEETS.USERS);
    if (!userSheet) throw new Error(`Sheet '${SHEETS.USERS}' not found.`);
    
    const data = userSheet.getDataRange().getValues();
    const headers = data.shift();
    
    const usernameIndex = headers.indexOf('username');
    const passwordIndex = headers.indexOf('password');
    const displayNameIndex = headers.indexOf('displayName');
    const typeIndex = headers.indexOf('type');

    let userFound = null;
    for (let i = 0; i < data.length; i++) {
      if (data[i][usernameIndex] === username) {
        if (data[i][passwordIndex] == password) {
          userFound = {
            username: data[i][usernameIndex],
            displayName: data[i][displayNameIndex],
            type: data[i][typeIndex]
          };
        }
        break;
      }
    }

    const response = userFound ? { result: 'success', user: userFound } : { result: 'error', message: 'اسم المستخدم أو كلمة المرور غير صحيحة' };
    return ContentService.createTextOutput(`${callback}(${JSON.stringify(response)})`).setMimeType(ContentService.MimeType.JAVASCRIPT);

  } catch (error) {
    console.error('Error in handleLogin:', error);
    const response = { result: 'error', message: error.message };
    return ContentService.createTextOutput(`${callback}(${JSON.stringify(response)})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
}

function getAchievements(e) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.ACHIEVEMENTS);
  if (!sheet) throw new Error(`Sheet '${SHEETS.ACHIEVEMENTS}' not found.`);
  
  if (sheet.getLastRow() <= 1) {
    const response = { result: 'success', data: [] };
    return ContentService.createTextOutput(`${e.parameter.callback}(${JSON.stringify(response)})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
  
  const dataRange = sheet.getDataRange();
  const values = dataRange.getValues();
  const headers = values.shift();
  
  const data = values.map(row => {
    let obj = {};
    headers.forEach((header, index) => { obj[header] = row[index] || ''; });
    return obj;
  });
  
  const response = { result: 'success', data: data };
  return ContentService.createTextOutput(`${e.parameter.callback}(${JSON.stringify(response)})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
}

function handleUpdateRequest(request, callback) {
  let response = {};
  try {
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEETS.ACHIEVEMENTS);
    if (!sheet) throw new Error(`Sheet '${SHEETS.ACHIEVEMENTS}' not found.`);
    
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const colIndexToUpdate = headers.indexOf(request.field) + 1;
    const idColIndex = headers.indexOf('id') + 1;

    if (colIndexToUpdate === 0 || idColIndex === 0) throw new Error("Column not found.");
    if (sheet.getLastRow() <= 1) throw new Error("No data to update.");

    const ids = sheet.getRange(2, idColIndex, sheet.getLastRow() - 1, 1).getValues();
    let rowIndexToUpdate = -1;
    for (let i = 0; i < ids.length; i++) {
      if (ids[i][0] == request.id) {
        rowIndexToUpdate = i + 2;
        break;
      }
    }

    if (rowIndexToUpdate !== -1) {
      sheet.getRange(rowIndexToUpdate, colIndexToUpdate).setValue(request.value);
      response = { result: 'success', message: 'Updated successfully' };
    } else {
      throw new Error(`ID ${request.id} not found.`);
    }

  } catch (error) {
    console.error('Error in handleUpdateRequest:', error);
    response = { result: 'error', message: error.message };
  }
  
  return ContentService.createTextOutput(`${callback}(${JSON.stringify(response)})`).setMimeType(ContentService.MimeType.JAVASCRIPT);
}
